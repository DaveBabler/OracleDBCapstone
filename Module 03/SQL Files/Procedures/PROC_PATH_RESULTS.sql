CREATE OR REPLACE PROCEDURE PROC_PATH_RESULTS(
	/*upated for invoicing support*/
	p_laborderid IN PATHOLOGY_LAB_ORDERS.LABORDERID%TYPE, 
	p_critdisease IN PATHOLOGY_HISTORY.CRITICAL_DISEASE%TYPE,
	p_results IN PATHOLOGY_HISTORY.RESULTS%TYPE
	)

AS
	lv_labid PATHOLOGY_LAB_ORDERS.LABID%TYPE;
	lv_kits PATHOLOGY_LAB_TESTS.KITS_ON_HAND%TYPE;
	lv_invid INVOICE_OPEN.INVOICEID%TYPE;
	lv_labcost PATHOLOGY_LAB_TESTS.LAB_COST%TYPE;
	lv_petid ANIMAL_FACTS.PETID%TYPE;


	missinglab_ex EXCEPTION;

BEGIN
	--begin section to remove one lab kit from inventory
	SELECT LABID
	INTO lv_labid
	FROM PATHOLOGY_LAB_ORDERS
	WHERE LABORDERID = p_laborderid;

	SELECT KITS_ON_HAND, LAB_COST
	INTO lv_kits, lv_labcost
	FROM PATHOLOGY_LAB_TESTS
	WHERE LABID = lv_labid;

	UPDATE PATHOLOGY_LAB_TESTS
	SET KITS_ON_HAND = lv_kits - 1
	WHERE LABID = lv_labid;
	--END labkit inventory UPDATE

	--update the completeion date to today's date

	UPDATE PATHOLOGY_LAB_ORDERS
	SET DATE_COMPLETED = SYSDATE
	WHERE LABORDERID = p_laborderid;

	COMMIT;
	--begin final merge into the patient chart

	MERGE INTO PATHOLOGY_HISTORY ph 
		USING PATHOLOGY_LAB_ORDERS po 
		ON (ph.LABORDERID = po.LABORDERID)

		WHEN MATCHED THEN
			UPDATE SET ph.DATE_COMPLETED = po.DATE_COMPLETED, 
			ph.CRITICAL_DISEASE = p_critdisease, 
			ph.RESULTS = p_results
			WHERE ph.LABORDERID = p_laborderid;



--BEGIN INVOICE SECTION
--start by grabbing the PETID
	SELECT PETID
	INTO lv_petid
	FROM PATHOLOGY_HISTORY
	WHERE LABORDERID = p_laborderid ;

	

	--get or generate invoice number
	PROC_GETINVNUM(lv_petid, lv_invid);

	INSERT INTO INVOICE_OPEN(INVOICEID, PETID, DATE_INVOICE_CREATION, LABID, LAB_COST)
	VALUES(lv_invid, lv_petid, SYSDATE, lv_labid, lv_labcost);


EXCEPTION
	WHEN missinglab_ex THEN

	DBMS_OUTPUT.PUT_LINE('The LABORDERID does not exist, LABORDERIDs are generated by the lab_history table; alert the DBA immediately with this exact');

END;


--TESTING
EXECUTE PROC_PATH_RESULTS(2, 'N', 'Mites found are common to this species of snake, can be removed with a gentle bath of 1mL of DAWN detergent to 2L of water no hotter than 35° Celsius / 95° Fahrenheit');
EXECUTE PROC_PATH_RESULTS(1, '0', 'THIS WASN''T EVEN A MITE IT WAS A PIECE OF LINT!!!!!');
EXECUTE PROC_PATH_RESULTS(3, 'Y', 'Patient has tested FIV+, all FIV antigens show positive, patient is contagious to other felines.  All other bloodwork is well within range for a healthy cat.');
